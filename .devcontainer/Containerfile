# -------- Build Stage --------
FROM node:23.11.0 AS builder

RUN apt-get update && apt-get install -y -qq \
    git \
    curl \
    vim \
    neovim \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /workspace
ENV PATH="/workspace/node_modules/.bin:$PATH"

RUN corepack enable && corepack prepare pnpm@latest --activate

COPY package.json pnpm-lock.yaml ./

RUN pnpm install --frozen-lockfile

COPY . .

RUN pnpm build

# -------- Production Stage --------
FROM node:23.11.0

RUN corepack enable && corepack prepare pnpm@latest --activate

WORKDIR /workspace

COPY --from=builder /workspace/package.json ./package.json
COPY --from=builder /workspace/pnpm-lock.yaml ./pnpm-lock.yaml
COPY --from=builder /workspace/.next ./.next
COPY --from=builder /workspace/public ./public
COPY --from=builder /workspace/next.config.ts ./next.config.ts

RUN pnpm install --prod --frozen-lockfile

USER node

ENV PORT=2999

EXPOSE 2999

# ðŸš‘ Add Healthcheck
HEALTHCHECK --interval=30s --timeout=5s --start-period=10s CMD wget --spider --quiet http://localhost:2999/ || exit 1

CMD ["pnpm", "start"]

